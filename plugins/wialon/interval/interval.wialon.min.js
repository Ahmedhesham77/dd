/**
 * Interval Selection module for Wialon Apps
 *
 * @filename: interval.wialon
 * @version 0.2.2
 *
 * @author Dzmitry Khadorkin <diha@gurtam.com>
 * @copyright 2002-2023 Gurtam
 * @license http://www.gnu.org/licenses/lgpl.html LGPL
 **/
!function(a){"use strict";var b=function(c,d){if(!this instanceof b)return new b(c,d);var e={};d||(d={}),this.el_=c,this.from_=a(".iw-from",this.el_),this.to_=a(".iw-to",this.el_),this.df_=this.__convertDF(d.dateFormat),this.wd_=d.firstDay,this.timezone_diff_=d.tzOffset-this.__getLocalTimezone(),this.time_type_=1,this.time_custom_=null,this.last_time_=null,this.now_=d.now,this.today_=this.__getToday(),e=a.extend({},{firstDay:this.wd_>1?0:1,dateFormat:this.df_,defaultDate:"+1w",showButtonPanel:!1,maxDate:"+0d",prevText:"&#9668;",nextText:"&#9658;"},d.datepicker),this.from_.datepicker(a.extend({},e,{onSelect:function(b,c){try{a.datepicker.parseDate(this.df_,b)}catch(d){b=a.datepicker.parseDate("yy-mm-dd",[~~c.selectedYear,~~c.selectedMonth+1,~~c.selectedDay].join("-")),this.from_.datepicker("option","defaultDate",b).datepicker("setDate",b)}this.to_.datepicker("option","minDate",b),this.to_.val()||this.to_.datepicker("option","defaultDate",b).datepicker("setDate",b)}.bind(this)})),this.to_.datepicker(a.extend({},e,{onSelect:function(b,c){try{a.datepicker.parseDate(this.df_,b)}catch(d){b=a.datepicker.parseDate("yy-mm-dd",[~~c.selectedYear,~~c.selectedMonth+1,~~c.selectedDay].join("-")),this.to_.datepicker("option","defaultDate",b).datepicker("setDate",b)}this.from_.datepicker("option","maxDate",b),this.from_.val()||this.from_.datepicker("option","defaultDate",b).datepicker("setDate",b)}.bind(this)})),this.time=this.time.bind(this),this.similar=this.similar.bind(this),this.triggerChangeTime=this.triggerChangeTime.bind(this),this.reset=this.reset.bind(this),a(".iw-period-btn",this.el_).on("click",this.time),a(".iw-similar-btn",this.el_).on("click",this.similar),a(".iw-time-btn",this.el_).on("click",this.triggerChangeTime),a(".iw-reset-btn",this.el_).on("click",this.reset),this.changeTime(this.time_type_)};b.prototype.destroy=function(){return this.from_.datepicker("destroy"),this.to_.datepicker("destroy"),a(".iw-period-btn",this.el_).off(),a(".iw-similar-btn",this.el_).off(),a(".iw-time-btn",this.el_).off(),a(".iw-reset-btn",this.el_).off(),this},b.prototype.__getToday=function(){var a=new Date(1e3*(this.now_+this.timezone_diff_)),b=null;return a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0),b=new Date(a),b.setSeconds(b.getSeconds()+86399),{from_:0|Math.floor(a.getTime()/1e3),to_:0|Math.floor(b.getTime()/1e3)}},b.prototype.__convertDF=function(a){var b=a;return b=b.match(/yyyy/g)?b.replace(/yyyy/g,"yy"):b.replace(/yy/g,"y"),b=b.match(/MMMM/g)?b.replace(/MMMM/g,"MM"):b.match(/MMM/g)?b.replace(/MMM/g,"M"):b.match(/MM/g)?b.replace(/MM/g,"mm"):b.replace(/M/g,"m"),b=b.match(/dddd/g)?b.replace(/dddd/g,"DD"):b.replace(/ddd/g,"D")},b.prototype.__getLocalTimezone=function(){var a=new Date,b=new Date(a.getFullYear(),0,1,0,0,0,0),c=new Date(a.getFullYear(),6,1,0,0,0,0),d=b.toGMTString(),e=new Date(d.substring(0,d.lastIndexOf(" ")-1));d=c.toGMTString();var f,g=new Date(d.substring(0,d.lastIndexOf(" ")-1)),h=(b-e)/36e5,i=(c-g)/36e5;if(h===i)f=0;else{var j=h-i;j>=0&&(h=i),f=1}return Math.floor(3600*h)},b.prototype.triggerChangeTime=function(a,b,c){if(a){a.preventDefault();var e=this.from_.datepicker("getDate"),f=this.to_.datepicker("getDate");this.time_from_=Math.round(e.getTime()/1e3),this.time_to_=Math.round(f.setDate(f.getDate()+1)/1e3)-1}var g=this.getInterval();return"function"==typeof c&&c.call(),a&&(this.showLabel(4),d.__trigger.apply(this.el_,["onAfterClick",4])),this.last_time_&&this.last_time_[0]===g[0]&&this.last_time_[1]===g[1]||(this.last_time_=g,b||d.__trigger.apply(this.el_,["onChange",this.time_type_,g])),this},b.prototype.getInterval=function(a){var b=this.time_from_,c=this.time_to_,d=a?this.timezone_diff_:0;return b&&c?[b-d,c-d]:[0,0]},b.prototype.changePeriod=function(b){var c=this.time_type_;a(".iw-select .active",this.el_).length>0&&(c=a(".iw-select .active",this.el_).data("period")||0),c=~~c;var d=this.getInterval(),e=new Date(1e3*this.today_.to_),f=null,g=null;switch(c){case 0:case 1:f=1e3*(b?d[0]+86400:d[0]-86400),g=1e3*(b?d[0]+172800-1:d[0]-1);break;case 2:f=1e3*(b?d[0]+604800:d[0]-604800),g=1e3*(b?d[0]+1209600-1:d[0]-1);break;case 3:f=new Date(1e3*d[0]),f.setMonth(b?f.getMonth()+1:f.getMonth()-1),g=new Date(f),b&&g.setMonth(g.getMonth()+1),g=b?g.getTime()-1e3:1e3*(d[0]-1)}return f=new Date(f),g=new Date(g),f>e?this:(g>e&&(g=e),this.time_from_=Math.floor(f.getTime()/1e3),this.time_to_=Math.floor(g.getTime()/1e3),this.showLabel(c),(0===c||1===c)&&(a(".iw-select .active",this.el_).removeClass("active"),this.time_from_===this.today_.from_-86400&&this.time_to_===this.today_.to_-86400?a(".iw-select .period_0",this.el_).addClass("active"):this.time_from_===this.today_.from_&&this.time_to_===this.today_.to_&&a(".iw-select .period_1",this.el_).addClass("active")),this.triggerChangeTime(),this)},b.prototype.changeTime=function(a,b,c){var d=b||this.getInterval();if(a=~~a||0,(4===a||null===this.time_custom_)&&(this.time_custom_=d),this.time_type_=a,b)this.time_from_=b[0],this.time_to_=b[1];else if(4>a){var e=new Date(1e3*this.today_.from_),f=new Date(1e3*this.today_.to_);if(-1!==a){switch(a){case 0:f=new Date(e.getTime()-1e3),e=new Date(e.getTime()-864e5);break;case 2:var g=e.getDay(),h=e.getDate()-g+(0===g?-7:0)+(this.wd_>1?0:1);h=new Date(e.setDate(h)),f=new Date(h.setDate(h.getDate())),e=new Date(h.setDate(h.getDate()-7));break;case 3:var i=new Date(e.setDate(1));f=new Date(i),i.setDate(i.getDate()-1),i.setDate(1),e=new Date(i)}e=Math.floor(e.getTime()/1e3),f=Math.floor(f.getTime()/1e3),(2===a||3===a)&&(f-=1),(e!==d[0]||f!==d[1])&&(this.time_from_=e,this.time_to_=f)}else this.time_from_=0,this.time_to_=0}else null!==this.time_custom_&&(this.time_from_=this.time_custom_[0],this.time_to_=this.time_custom_[1]);return 4!==a||b?this.triggerChangeTime(null,c,function(){this.activateTimeTemplate(a)}.bind(this)):this.activateTimeTemplate(a),this},b.prototype.activateTimeTemplate=function(b){a(".iw-select .active",this.el_).removeClass("active");var c=a(".iw-select .period_"+b,this.el_);if(!c&&!c.length&&-1!==b)return this;0===b||1===b?(this.time_from_===this.today_.from_-86400&&this.time_to_===this.today_.to_-86400||this.time_from_===this.today_.from_&&this.time_to_===this.today_.to_)&&c.addClass("active"):-1!==b&&c.addClass("active");var d=a(".iw-pickers",this.el_),e=a(".iw-labels",this.el_);if(-1===b)d.hide(),e.hide();else if(4>b)this.showLabel(b),d.hide(),e.show();else{var f=new Date(1e3*this.time_from_),g=new Date(1e3*this.time_to_);this.from_.datepicker("option","maxDate",g).datepicker("option","defaultDate",f).datepicker("setDate",f),this.to_.datepicker("option","maxDate",new Date(1e3*this.today_.to_)).datepicker("option","minDate",f).datepicker("option","defaultDate",g).datepicker("setDate",g),this.showLabel(4),d.show(),e.hide()}return this},b.prototype.time=function(b){b.preventDefault();var c=a(b.currentTarget).data("period")||0;if(4===c){var e=this.getInterval();if(0===e[0]&&0===e[1])return this.changeTime(0,null,1).time(b),this}return this.changeTime(c),d.__trigger.apply(this.el_,["onAfterClick",c]),this},b.prototype.reset=function(a){return a.preventDefault(),this.changeTime(-1),d.__trigger.apply(this.el_,["onAfterClick",-1]),this},b.prototype.similar=function(b){b.preventDefault();var c=a(b.currentTarget).data("similar"),d=c&&"future"===c?1:0;return this.changePeriod(d),this},b.prototype.showLabel=function(b){var c=this.getInterval(),d=new Date(1e3*c[0]),e=new Date(1e3*c[1]),f=a.datepicker.formatDate(this.df_,d);return f+=b>1?" &nbsp;â€“&nbsp; "+a.datepicker.formatDate(this.df_,e):"",a(".iw-label",this.el_).html(f),this};var c={id:"",className:"",template:'<div class="interval-wialon-container {className}" id="{id}">   <div class="iw-select">       <button data-period="0" type="button" class="iw-period-btn period_0">{yesterday}</button>       <button data-period="1" type="button" class="iw-period-btn period_1">{today}</button>       <button data-period="2" type="button" class="iw-period-btn period_2">{week}</button>       <button data-period="3" type="button" class="iw-period-btn period_3">{month}</button>       <button data-period="4" type="button" class="iw-period-btn period_4">{custom}</button>   </div>   <div class="iw-pickers">       <input type="text" class="iw-from" />&ndash;<input type="text" class="iw-to" />       <button type="button" class="iw-time-btn">{ok}</button>   </div>   <div class="iw-labels">       <a href="#" class="iw-similar-btn" data-similar="past"><i class="icon-left"></i></a>       <a href="#" class="iw-similar-btn" data-similar="future"><i class="icon-right"></i></a>       <span class="iw-label"></span>   </div>   <div class="iw-reset">       <button type="button" class="iw-reset-btn">{reset}</button>   </div></div>',labels:{yesterday:"Yesterday",today:"Today",week:"Week",month:"Month",custom:"Custom",ok:"OK",reset:"Reset"},datepicker:{},dateFormat:"yyyy-MM-dd",firstDay:1,tzOffset:0,now:Math.floor((new Date).getTime()/1e3)},d={init:function(e){return this.each(function(){var f=a(this),g=d.__getData.apply(f);if("dateFormat"in e&&!e.dateFormat&&delete e.dateFormat,e=a.extend({},c,e),!g){var h=e.template;h=h.replace(/\{className\}/,e.className),h=h.replace(/\{id\}/,e.id),h=h.replace(/\{yesterday\}/,e.labels.yesterday),h=h.replace(/\{today\}/,e.labels.today),h=h.replace(/\{week\}/,e.labels.week),h=h.replace(/\{month\}/,e.labels.month),h=h.replace(/\{custom\}/,e.labels.custom),h=h.replace(/\{ok\}/,e.labels.ok),h=h.replace(/\{reset\}/,e.labels.reset),f.html(h),f.data("intervalWialon",{options:e,target:new b(f,e)}),d.__trigger.apply(f,["onInit"])}})},__trigger:function(b){if("string"!=typeof b)return!1;var c=a(this),e=d.__getData.apply(c,["options"]),f=Array.prototype.slice.call(arguments,1);e&&e[b]&&"function"==typeof e[b]&&e[b](f),setTimeout(function(){c.trigger(b,f)},0)},__getData:function(b){var c=a(this).data("intervalWialon");return c?b?b in c?c[b]:null:c:null},get:function(b){var c=d.__getData.apply(a(this),["target"]);return c&&c.getInterval(b)},set:function(b,c,e){var f=d.__getData.apply(a(this),["target"]);return f&&f.changeTime(b,c,e)},type:function(){var b=d.__getData.apply(a(this),["target"]);return b&&b.time_type_},label:function(){var b=a(this),c=d.__getData.apply(b,["target"]),e=a(".iw-label",b).html(),f=c&&c.time_type_;return-1===f&&(e="Full"),e},today:function(){var b=d.__getData.apply(a(this),["target"]);return b&&b.today_},timezone_diff:function(){var b=d.__getData.apply(a(this),["target"]);return b&&b.timezone_diff_},destroy:function(){return this.each(function(){var b=a(this),c=d.__getData.apply(b,["target"]);c&&c.destroy(),b.removeData("intervalWialon").empty()})},reset:function(){return this.each(function(){var b=a(this),c=d.__getData.apply(b,["options"]);d.destroy.apply(b),d.init.apply(b,[c]),d.__trigger.apply(b,["onReset"])})}};if("undefined"==typeof a||"undefined"==typeof a.ui||"undefined"==typeof a.fn.datepicker)throw new Error("IntervalWialon requires jQuery, jQuery UI Core and jQuery UI Datepicker.");a.fn.intervalWialon=function(b){return d[b]?d[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error('[intervalWialon] Method "'+b+'" is not defined'):d.init.apply(this,arguments)}}(window.jQuery);